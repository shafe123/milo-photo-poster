name: Deploy to Azure Functions

on:
    push:
        branches:
            - main

env:
    AZURE_FUNCTIONAPP_NAME: milo-photo-poster
    AZURE_FUNCTIONAPP_PACKAGE_PATH: "."
    PYTHON_VERSION: "3.11"

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: "Checkout GitHub Action"
              uses: actions/checkout@v3

            - name: Setup Python ${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v4
              with:
                  python-version: ${{ env.PYTHON_VERSION }}

            - name: "Install dependencies"
              run: |
                  pip install -r requirements.txt

            - name: "Azure login"
              uses: azure/login@v2
              with:
                  client-id: ${{ secrets.AZURE_CLIENT_ID }}
                  tenant-id: ${{ secrets.AZURE_TENANT_ID }}
                  subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

            - name: "Deploy to Azure Functions"
              uses: Azure/functions-action@v1
              with:
                  app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
                  package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
                  publish-profile: ${{ secrets.AZURE_FUNCTIONAPP_PUBLISH_PROFILE }}
